<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0A313E">
  <title>Mr.Packaging - Tienda</title>
  <style>
    /* --- ESTILOS WEB RESPONSIVA (TAMAÃ‘OS AFINADOS) --- */
    :root {
      --primary-color: #0A313E;
      --secondary-color: #1a4d5e;
      --accent-color: #e53935; 
      --buy-color: #FF9900; 
      --success-color: #2e7d32;
      --light-bg: #f5f5f5;
      --white: #ffffff;
      --text-dark: #222222;
      --shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--text-dark);
      font-size: 15px; 
      padding-bottom: 50px;
    }

    /* HEADER Y FILTROS */
    .top-nav-container {
      position: sticky; top: 0; z-index: 1000;
      background: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    header {
      color: var(--white); padding: 12px 18px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; }
    
    .top-cart-container {
      background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;
      display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s;
    }
    .top-cart-container:active { background: rgba(255,255,255,0.3); }
    .top-cart-icon { font-size: 1.2rem; line-height: 1;}
    .top-cart-text { font-weight: bold; font-size: 1rem; color: white;}
    
    /* BADGE CORREGIDO (Forma de PÃ­ldora para alojar hasta 4 dÃ­gitos sin montarse) */
    .top-cart-badge {
      background: var(--buy-color); color: #000; border-radius: 12px; 
      min-width: 24px; height: 24px; padding: 0 6px; font-size: 0.95rem; font-weight: 900; 
      display: flex; justify-content: center; align-items: center; 
    }

    .filter-container {
      display: flex; overflow-x: auto; gap: 10px; padding: 12px 15px; scrollbar-width: none; background: var(--primary-color); border-top: 1px solid rgba(255,255,255,0.1);
    }
    .filter-container::-webkit-scrollbar { display: none; }
    .filter-btn {
      flex: 0 0 auto; padding: 8px 20px; border: none; background-color: rgba(255,255,255,0.15); color: var(--white); border-radius: 25px; font-weight: 800; font-size: 0.95rem; cursor: pointer;
    }
    .filter-btn.active { background-color: var(--buy-color); color: #000; }

    .container { padding: 15px; max-width: 800px; margin: 0 auto; }

    /* TARJETAS */
    .products-grid { display: flex; flex-direction: column; gap: 30px; }
    
    .product-card {
      background-color: var(--white); border-radius: 16px; box-shadow: var(--shadow); 
      display: flex; flex-direction: column; overflow: hidden;
    }

    .product-image-container { 
      position: relative; width: 100%; height: 320px; 
      background: #fff; border-bottom: 1px solid #f0f0f0; padding: 10px; 
    }
    .product-slide { width: 100%; height: 100%; object-fit: contain; display: none; } 
    .product-slide.active { display: block; }
    
    .card-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; z-index: 5; cursor: pointer;}
    .card-nav.prev { left: 10px; }
    .card-nav.next { right: 10px; }
    .photo-badge { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }

    .product-info { padding: 20px 15px; display: flex; flex-direction: column; }
    
    .product-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .product-titles { flex: 1; padding-right: 15px; }
    .product-name { font-size: 1.4rem; font-weight: 900; color: var(--primary-color); line-height: 1.2; margin-bottom: 6px; }
    .product-description { font-size: 1rem; color: #666; line-height: 1.4; }
    
    .color-select { width: 120px; padding: 10px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; background-color: var(--light-bg); font-weight: 800; color: var(--primary-color); outline: none; cursor: pointer; }

    .purchase-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: #fafafa; padding: 12px; border-radius: 14px; border: 1px solid #eee;}
    
    .stepper-container { display: flex; align-items: center; background: var(--white); border-radius: 30px; padding: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd;}
    .stepper-btn { background: var(--white); border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 2rem; color: var(--primary-color); cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 4px; transition: background 0.2s; }
    .stepper-btn:active { background: #e0e0e0; }
    .stepper-val { width: 60px; text-align: center; font-weight: 900; font-size: 1.3rem; color: var(--text-dark); }
    
    .total-preview-container { text-align: right; }
    .total-label { font-size: 0.8rem; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 2px;}
    .total-preview { font-weight: 900; font-size: 1.6rem; color: var(--success-color); line-height: 1;}

    .add-to-cart-btn { background-color: var(--primary-color); color: var(--white); border: none; padding: 16px; border-radius: 14px; font-weight: 900; font-size: 1.2rem; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.2s;}
    .add-to-cart-btn:active { transform: scale(0.98); }
    
    .view-prices-btn { background: transparent; border: none; color: #1565C0; font-weight: 800; font-size: 1.1rem; width: 100%; padding: 15px 0 0 0; text-align: center; text-decoration: underline; cursor: pointer;}

    /* MODALES */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: flex-end; padding: 10px; }
    .modal.active { display: flex; animation: slideUpWeb 0.3s ease-out; }
    @keyframes slideUpWeb { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .modal-content { background: var(--light-bg); width: 100%; max-width: 800px; max-height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; overflow: hidden; }

    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: var(--white); color: var(--text-dark); border-bottom: 1px solid #eee; z-index: 2001; }
    .modal-header h2 { font-size: 1.5rem; margin: 0; font-weight: 900; }
    .modal-close { background: #f5f5f5; color: var(--text-dark); border: none; font-size: 1.5rem; font-weight: bold; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer;}
    .modal-body { flex: 1; overflow-y: auto; padding: 15px; background: var(--light-bg); -webkit-overflow-scrolling: touch; }

    .modal-centered { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; padding: 20px; }
    .modal-centered-content { background: white; border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center; animation: scaleUp 0.3s ease-out; }
    @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    #priceModalProductName { font-weight: 900; font-size: 1.4rem; color: var(--primary-color); margin-bottom: 15px; line-height: 1.3;}
    .price-table { width: 100%; border-collapse: collapse; font-size: 1.2rem; margin-bottom: 20px;}
    .price-table td { padding: 15px 10px; border-bottom: 1px solid #eee; text-align: left; }
    .price-qty-col { color: #555; font-weight: 700; }
    .price-val-col { text-align: right !important; font-weight: 900; color: var(--primary-color); font-size: 1.3rem; }

    /* CARRITO DE COMPRAS CON CONTROLES */
    .cart-item { background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px; display: flex; gap: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .cart-item img { width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background: #f9f9f9; border: 1px solid #eee;}
    .cart-item-name { font-size: 1.1rem; font-weight: 900; margin-bottom: 4px; color: var(--primary-color); line-height: 1.2;}
    .cart-item-details { font-size: 0.95rem; color: #666; font-weight: 600;}
    
    .cart-item-controls { display: flex; align-items: center; background: #f9f9f9; border-radius: 20px; padding: 2px; border: 1px solid #eee; }
    .cart-stepper-btn { background: var(--white); border: 1px solid #ddd; width: 32px; height: 32px; border-radius: 50%; font-size: 1.5rem; color: var(--primary-color); cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 3px; transition: background 0.2s; }
    .cart-stepper-btn:active { background: #e0e0e0; }
    .cart-stepper-val { width: 45px; text-align: center; font-weight: 900; font-size: 1.1rem; color: var(--text-dark); }
    
    .cart-remove-btn { background: #ffebee; color: var(--accent-color); border: none; padding: 6px 12px; border-radius: 8px; font-weight: 900; font-size: 0.9rem; cursor: pointer;}
    
    .cart-summary { background: white; padding: 20px; border-radius: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-top: 15px; margin-bottom: 15px; }
    .summary-row { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 12px; color: #555; font-weight: 700; }
    .summary-total { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 900; color: var(--success-color); border-top: 2px solid #eee; padding-top: 15px; margin-top: 5px; }

    .btn-realizar-pedido { width: 100%; background: var(--buy-color); color: #000; padding: 18px; border: none; border-radius: 14px; font-weight: 900; font-size: 1.3rem; box-shadow: 0 4px 10px rgba(255,153,0,0.3); margin-bottom: 15px; cursor: pointer;}
    .btn-seguir-comprando { width: 100%; background: #e0e0e0; color: var(--text-dark); padding: 18px; border: none; border-radius: 14px; font-weight: 900; font-size: 1.1rem; margin-bottom: 25px; cursor: pointer; }
    
    .checkout-form { background:white; padding:20px; border-radius:14px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 25px;}
    .checkout-form input, .checkout-form textarea { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; margin-bottom: 12px; background-color: var(--white); font-weight: 600; outline: none; }
    .checkout-form input:focus, .checkout-form textarea:focus { border-color: var(--primary-color); }
    .checkout-btn { width: 100%; background: var(--buy-color); color: #000; padding: 18px; border: none; border-radius: 14px; font-weight: 900; font-size: 1.3rem; margin-top: 8px; cursor: pointer;}
    
    .btn-volver-carrito { width: 100%; background: transparent; color: #666; padding: 12px; border: none; font-weight: 800; font-size: 1.1rem; margin-top: 10px; text-decoration: underline; cursor: pointer;}

    .notification { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 14px 25px; border-radius: 30px; z-index: 6000; display: none; font-size: 1rem; font-weight: 900; white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .notification.error { background-color: var(--accent-color); }

    .loading { text-align: center; padding: 4rem 0; }
    .spinner { border: 5px solid #ddd; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .modal-image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; }
    .modal-image-content { max-width: 100%; max-height: 100%; object-fit: contain; }
    .close-zoom-fixed { position: absolute; top: 20px; right: 20px; color: white; background: rgba(255,255,255,0.2); border: 2px solid white; width: 50px; height: 50px; border-radius: 50%; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* LOGO WHATSAPP OFICIAL SVG */
    .whatsapp-fab {
      position: fixed; bottom: 25px; right: 20px;
      background-color: #25D366; color: white; width: 60px; height: 60px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(37,211,102,0.4); text-decoration: none; z-index: 900;
      transition: transform 0.2s;
    }
    .whatsapp-fab:active { transform: scale(0.95); }
    .whatsapp-fab svg { width: 35px; height: 35px; fill: white; }
  </style>

  <!-- SDK DE FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- HEADER -->
  <div class="top-nav-container">
    <header>
      <div class="logo">MR.PACKAGING</div>
      <div class="top-cart-container" onclick="openCart()">
        <span class="top-cart-icon">ðŸ›’</span>
        <span class="top-cart-text">Pedido</span>
        <span class="top-cart-badge" id="topCartCount">0</span>
      </div>
    </header>
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
      <button class="filter-btn" onclick="filterProducts('Cajas', this)">Cajas</button>
      <button class="filter-btn" onclick="filterProducts('Bolsas', this)">Bolsas</button>
      <button class="filter-btn" onclick="filterProducts('Tag', this)">Tag</button>
      <button class="filter-btn" onclick="filterProducts('Papel Seda', this)">Papel Seda</button>
      <button class="filter-btn" onclick="filterProducts('Sticker', this)">Sticker</button>
    </div>
  </div>

  <!-- CATÃLOGO PRINCIPAL -->
  <div class="container">
    <div class="products-grid" id="productsGrid">
      <div class="loading">
        <div class="spinner"></div>
        <p style="font-size:1.2rem; color:#666; font-weight:900;">Cargando inventario...</p>
      </div>
    </div>
  </div>

  <!-- BOTÃ“N FLOTANTE WHATSAPP CON SVG OFICIAL -->
  <a href="https://wa.me/50372635125?text=Hola!%20Tengo%20una%20consulta%20sobre%20empaques" target="_blank" class="whatsapp-fab">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
      <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
    </svg>
  </a>

  <!-- MODAL CARRITO -->
  <div class="modal" id="cartModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ðŸ›’ Tu Pedido</h2>
        <button class="modal-close" onclick="closeCart()">Ã—</button>
      </div>
      <div class="modal-body" id="cartContent"></div>
    </div>
  </div>

  <!-- MODAL DE PRECIOS CENTRADO -->
  <div class="modal-centered" id="priceModal">
    <div class="modal-centered-content">
      <h2 id="priceModalProductName"></h2>
      <table class="price-table">
        <tbody id="priceTableBody"></tbody>
      </table>
      <button style="width:100%; padding:14px; background:var(--primary-color); color:white; border-radius:12px; font-size:1.2rem; font-weight:bold; border:none; cursor:pointer;" onclick="closePriceModal()">Entendido</button>
    </div>
  </div>

  <!-- MODAL DE SALIDA -->
  <div class="modal-centered" id="exitModal">
    <div class="modal-centered-content">
      <h2 style="color:var(--primary-color); margin-bottom:12px; font-size:1.6rem; font-weight:900;">Â¿Ya te vas?</h2>
      <p id="exitModalText" style="color:#666; margin-bottom:20px; font-size:1.1rem; line-height:1.4;"></p>
      <button style="width:100%; padding:14px; background:var(--primary-color); color:white; border-radius:12px; font-size:1.2rem; font-weight:bold; border:none; margin-bottom:12px; cursor:pointer;" onclick="cancelExit()">Seguir comprando</button>
      <button style="width:100%; padding:14px; background:transparent; color:var(--accent-color); border-radius:12px; font-size:1.2rem; font-weight:bold; border:2px solid var(--accent-color); cursor:pointer;" onclick="confirmExit()">Salir de la tienda</button>
    </div>
  </div>

  <!-- MODAL Ã‰XITO -->
  <div class="modal-centered" id="successModal">
    <div class="modal-centered-content">
      <div style="font-size: 60px; color: #4CAF50; margin: 0 auto 15px auto; background: #e8f5e9; width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">âœ“</div>
      <h2 style="color:var(--primary-color); font-size:1.8rem; margin-bottom:12px; font-weight:900;">Â¡Orden Recibida!</h2>
      <p style="color: #666; margin-bottom: 25px; font-size: 1.1rem; line-height: 1.4;">Hemos enviado los detalles a tu correo electrÃ³nico.</p>
      <button style="width:100%; padding:14px; background:var(--primary-color); color:white; border-radius:12px; font-size:1.2rem; font-weight:bold; border:none; cursor:pointer;" onclick="closeSuccessModal()">Volver a la Tienda</button>
    </div>
  </div>

  <!-- MODAL ZOOM IMAGEN -->
  <div class="modal-image-overlay" id="imageZoomModal">
    <button class="close-zoom-fixed" onclick="closeImageModal()">Ã—</button>
    <img src="" class="modal-image-content" id="imgZoomContent">
  </div>

  <div class="notification" id="notification"></div>

  <script>
    const firebaseConfig = { databaseURL: "https://mrpackaging-app-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // NUEVA URL DE APPS SCRIPT
    const GAS_BACKEND_URL = "https://script.google.com/macros/s/AKfycby2KqCfXrbvtRuZeG6xcohfGvn-Y2j8uSTIINhn3GXfCZgqJa-LVS3Uo_ipDBc-ediu/exec";

    let products = [];
    let cart = [];
    let currentCategory = 'all'; 
    const DELIVERY_FEE = 3.50;
    let productSlideIndices = {}; 

    window.onload = function() { 
      history.pushState({page: 'trampa_salida'}, '', '#app');
      history.pushState({page: 'tienda_principal'}, '', '#tienda');
      loadProducts(); 
    };

    window.addEventListener('popstate', function(event) {
      const isCartOpen = document.getElementById('cartModal').classList.contains('active');
      const isPriceOpen = document.getElementById('priceModal').style.display === 'flex';
      const isZoomOpen = document.getElementById('imageZoomModal').style.display === 'flex';
      
      if (isCartOpen || isPriceOpen || isZoomOpen) {
        closeCart(); closePriceModal(); closeImageModal();
        history.pushState({page: 'tienda_principal'}, '', '#tienda'); 
        return;
      }
      if (event.state && event.state.page === 'trampa_salida') {
        const exitText = cart.length > 0 ? "Tienes empaques en tu pedido. Si sales ahora, se perderÃ¡ tu carrito." : "Esperamos verte de nuevo pronto.";
        document.getElementById('exitModalText').innerText = exitText;
        document.getElementById('exitModal').style.display = 'flex';
      }
    });

    function cancelExit() { document.getElementById('exitModal').style.display = 'none'; history.pushState({page: 'tienda_principal'}, '', '#tienda'); }
    function confirmExit() { history.go(-2); }

    async function loadProducts() {
      try {
        const snapshot = await db.ref('productos').once('value');
        const data = snapshot.val();
        if (data) {
          products = Object.values(data)
            .filter(p => p !== null && (p.activo === 'SÃ­' || p.activo === 'Si' || p.activo === 'sÃ­' || p.activo === 'si'))
            .map(p => {
              let imgArray = p.image ? p.image.toString().split(',').map(url => url.trim()).filter(url => url !== "") : [];
              if (imgArray.length === 0) imgArray = ['https://via.placeholder.com/300?text=No+Image'];
              return {
                id: p.id, name: p.name, category: p.category, description: p.description,
                images: imgArray, colors: Array.isArray(p.colors) ? p.colors : [p.colors], 
                priceTiers: p.priceTiers, stock: p.stock, activo: p.activo
              };
            });
        }
        renderProducts();
        const loader = document.querySelector('.loading');
        if (loader) loader.style.display = 'none';
      } catch (error) { showNotification('Error cargando el catÃ¡logo', 'error'); }
    }

    function filterProducts(category, btn) {
      currentCategory = category;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function calculatePrice(quantity, priceTiers) {
      if (quantity >= 1 && quantity <= 25) return priceTiers.tier1;
      if (quantity >= 26 && quantity <= 50) return priceTiers.tier2;
      if (quantity >= 51 && quantity <= 100) return priceTiers.tier3;
      if (quantity >= 101 && quantity <= 500) return priceTiers.tier4;
      return priceTiers.tier5;
    }

    // --- REGLAS POR CATEGORÃA PARA MINIMOS Y SALTOS ---
    function updateQty(productId, isPlus) {
      const product = products.find(p => p.id === productId);
      const cat = product.category ? product.category.toLowerCase() : '';
      
      let min = 25, step = 25;
      if (cat === 'tag') { min = 100; step = 100; }
      else if (cat === 'papel seda') { min = 50; step = 50; }

      const display = document.getElementById(`qty-display-${productId}`);
      let current = parseInt(display.innerText) || min; 
      
      let next = isPlus ? current + step : current - step;
      
      if (next < min) { showNotification(`El mÃ­nimo es ${min} unidades`, 'error'); next = min; }
      if (next > 1000) { showNotification('MÃ¡ximo 1000 unidades', 'error'); next = 1000; }
      
      display.innerText = next; 
      updatePricePreview(productId);
    }

    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      const filtered = currentCategory === 'all' ? products : products.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());
      if (filtered.length === 0) { grid.innerHTML = '<p style="text-align:center; padding:50px; color:#666; font-size:1.2rem; font-weight:900;">No hay productos.</p>'; return; }

      filtered.forEach(product => {
        productSlideIndices[product.id] = 0;
        const card = document.createElement('div');
        card.className = 'product-card';
        let imagesHtml = '';
        product.images.forEach((img, index) => {
          const activeClass = index === 0 ? 'active' : '';
          imagesHtml += `<img src="${img}" loading="lazy" class="product-slide ${activeClass}" id="slide-${product.id}-${index}" onclick="openImageZoom('${product.id}', ${index})">`;
        });
        let navHtml = '';
        if (product.images.length > 1) {
          navHtml = `<button class="card-nav prev" onclick="changeCardSlide('${product.id}', -1)">&#10094;</button><button class="card-nav next" onclick="changeCardSlide('${product.id}', 1)">&#10095;</button><div class="photo-badge" id="badge-${product.id}">1/${product.images.length}</div>`;
        }
        let colorOptionsHtml = '';
        if (product.colors && product.colors.length > 0 && product.colors[0] !== "") {
            colorOptionsHtml = `<select class="color-select" id="color-${product.id}">${product.colors.map(c => `<option value="${c.trim()}">${c.trim()}</option>`).join('')}</select>`;
        } else { colorOptionsHtml = `<input type="hidden" id="color-${product.id}" value="EstÃ¡ndar">`; }

        // InicializaciÃ³n del mÃ­nimo y precio basado en categorÃ­a
        const cat = product.category ? product.category.toLowerCase() : '';
        let min = 25;
        if (cat === 'tag') min = 100;
        else if (cat === 'papel seda') min = 50;

        const initialTotal = calculatePrice(min, product.priceTiers) * min;

        card.innerHTML = `
          <div class="product-image-container">${imagesHtml}${navHtml}</div>
          <div class="product-info">
            <div class="product-header-row"><div class="product-titles"><h3 class="product-name">${product.name}</h3><div class="product-description">${product.description}</div></div>${colorOptionsHtml}</div>
            <div class="purchase-controls">
              <div class="stepper-container"><button type="button" class="stepper-btn" onclick="updateQty('${product.id}', false)">-</button><div class="stepper-val" id="qty-display-${product.id}">${min}</div><button type="button" class="stepper-btn" onclick="updateQty('${product.id}', true)">+</button></div>
              <div class="total-preview-container"><div class="total-label">Subtotal</div><div class="total-preview" id="preview-${product.id}">$${initialTotal.toFixed(2)}</div></div>
            </div>
            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')">ðŸ›’ Agregar al Pedido</button>
            <button class="view-prices-btn" onclick="openPriceModal('${product.id}')">Ver tabla de precios por volumen</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function changeCardSlide(productId, direction) {
      const product = products.find(p => p.id === productId); if (!product) return;
      let currentIndex = productSlideIndices[productId]; document.getElementById(`slide-${productId}-${currentIndex}`).classList.remove('active');
      currentIndex += direction; if (currentIndex >= product.images.length) currentIndex = 0; if (currentIndex < 0) currentIndex = product.images.length - 1;
      productSlideIndices[productId] = currentIndex; document.getElementById(`slide-${productId}-${currentIndex}`).classList.add('active');
      const badge = document.getElementById(`badge-${productId}`); if(badge) badge.textContent = `${currentIndex + 1}/${product.images.length}`;
    }

    function openImageZoom(productId, index) { document.getElementById('imgZoomContent').src = products.find(p => p.id === productId).images[index]; document.getElementById('imageZoomModal').style.display = 'flex'; history.pushState({ modal: 'zoom' }, '', '#zoom'); }
    function closeImageModal() { document.getElementById('imageZoomModal').style.display = 'none'; }
    
    function openPriceModal(productId) {
      const product = products.find(p => p.id === productId);
      document.getElementById('priceModalProductName').textContent = product.name;
      document.getElementById('priceTableBody').innerHTML = `<tr><td class="price-qty-col">1 - 25 u.</td><td class="price-val-col">$${product.priceTiers.tier1.toFixed(2)}</td></tr><tr><td class="price-qty-col">26 - 50 u.</td><td class="price-val-col">$${product.priceTiers.tier2.toFixed(2)}</td></tr><tr><td class="price-qty-col">51 - 100 u.</td><td class="price-val-col">$${product.priceTiers.tier3.toFixed(2)}</td></tr><tr><td class="price-qty-col">101 - 500 u.</td><td class="price-val-col">$${product.priceTiers.tier4.toFixed(2)}</td></tr><tr><td class="price-qty-col" style="border:none;">501+ u.</td><td class="price-val-col" style="border:none;">$${product.priceTiers.tier5.toFixed(2)}</td></tr>`;
      document.getElementById('priceModal').style.display = 'flex'; history.pushState({ modal: 'precios' }, '', '#precios');
    }
    function closePriceModal() { document.getElementById('priceModal').style.display = 'none'; }

    function updatePricePreview(productId) {
      const product = products.find(p => p.id === productId);
      const display = document.getElementById(`qty-display-${productId}`);
      
      const cat = product.category ? product.category.toLowerCase() : '';
      let min = 25;
      if (cat === 'tag') min = 100; else if (cat === 'papel seda') min = 50;

      const quantity = parseInt(display.innerText) || min;
      document.getElementById(`preview-${productId}`).textContent = `$${(calculatePrice(quantity, product.priceTiers) * quantity).toFixed(2)}`;
    }

    // --- AGRUPACIÃ“N EN EL CARRITO ---
    function addToCart(productId) {
      const product = products.find(p => p.id === productId); 
      const colorInput = document.getElementById(`color-${productId}`);
      const color = colorInput ? colorInput.value : "EstÃ¡ndar";
      const display = document.getElementById(`qty-display-${productId}`);
      
      const cat = product.category ? product.category.toLowerCase() : '';
      let min = 25, step = 25;
      if (cat === 'tag') { min = 100; step = 100; }
      else if (cat === 'papel seda') { min = 50; step = 50; }

      const quantityToAdd = parseInt(display.innerText) || min;
      
      // Validamos si el producto con ESE color ya estÃ¡ en el carrito
      const existingItemIndex = cart.findIndex(item => item.id === product.id && item.color === color);

      if (existingItemIndex > -1) {
        // Se suma a la cantidad existente y se recalcula a un precio mejor si aplica
        cart[existingItemIndex].quantity += quantityToAdd;
        if (cart[existingItemIndex].quantity > 1000) cart[existingItemIndex].quantity = 1000;
        
        cart[existingItemIndex].unitPrice = calculatePrice(cart[existingItemIndex].quantity, product.priceTiers);
        cart[existingItemIndex].total = cart[existingItemIndex].unitPrice * cart[existingItemIndex].quantity;
      } else {
        // Se agrega como nuevo y se guarda su min y step para el carrito
        const unitPrice = calculatePrice(quantityToAdd, product.priceTiers);
        cart.push({ id: product.id, name: product.name, image: product.images[0], color: color, quantity: quantityToAdd, unitPrice: unitPrice, total: unitPrice * quantityToAdd, min: min, step: step });
      }

      updateCartCount(); 
      showNotification('Â¡Agregado a tu pedido!');
      
      // Reinicia visualmente la cantidad al mÃ­nimo de su categorÃ­a
      display.innerText = min; 
      updatePricePreview(productId);
    }

    // --- NUEVO: FUNCIÃ“N PARA ALTERAR CANTIDADES DENTRO DEL CARRITO ---
    function updateCartItemQty(index, direction) {
      let item = cart[index];
      let next = item.quantity + (direction * item.step);
      
      if (next < item.min) { 
        showNotification(`El mÃ­nimo es ${item.min} unidades`, 'error'); 
        return; 
      }
      if (next > 1000) { 
        showNotification('MÃ¡ximo 1000 unidades', 'error'); 
        return; 
      }
      
      const product = products.find(p => p.id === item.id);
      if (product) {
        item.quantity = next;
        item.unitPrice = calculatePrice(item.quantity, product.priceTiers);
        item.total = item.unitPrice * item.quantity;
        updateCartCount();
        renderCart(); // Vuelve a dibujar el carrito al instante
      }
    }

    function updateCartCount() { document.getElementById('topCartCount').textContent = cart.reduce((sum, item) => sum + item.quantity, 0); }
    function openCart() { renderCart(); document.getElementById('cartModal').classList.add('active'); history.pushState({ modal: 'carrito' }, '', '#carrito'); }
    function closeCart() { document.getElementById('cartModal').classList.remove('active'); }

    function renderCart() {
      const cartContent = document.getElementById('cartContent');
      if (cart.length === 0) { cartContent.innerHTML = '<div style="text-align:center; padding-top:60px;"><div style="font-size:5rem; opacity:0.2; margin-bottom:15px;">ðŸ›’</div><h3 style="color:#444; font-size:1.5rem; margin-bottom: 20px;">Tu pedido estÃ¡ vacÃ­o</h3><button class="btn-seguir-comprando" onclick="closeCart()">Agregar productos</button></div>'; return; }
      
      const subtotal = cart.reduce((sum, item) => sum + item.total, 0); const total = subtotal + DELIVERY_FEE;
      let itemsHtml = `<div>`;
      cart.forEach((item, index) => {
        itemsHtml += `
          <div class="cart-item">
            <img src="${item.image}">
            <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                  <div class="cart-item-name">${item.name}</div>
                  <div class="cart-item-details">${item.color}</div>
                </div>
                <button class="cart-remove-btn" style="margin-top:0; padding: 6px 10px; font-size: 0.85rem;" onclick="removeFromCart(${index})">Quitar</button>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <div class="cart-item-controls">
                  <button type="button" class="cart-stepper-btn" onclick="updateCartItemQty(${index}, -1)">-</button>
                  <div class="cart-stepper-val">${item.quantity}</div>
                  <button type="button" class="cart-stepper-btn" onclick="updateCartItemQty(${index}, 1)">+</button>
                </div>
                <div style="font-weight:900; font-size:1.3rem; color:var(--text-dark);">$${item.total.toFixed(2)}</div>
              </div>
            </div>
          </div>`;
      });
      itemsHtml += `</div><div class="cart-summary"><div class="summary-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div><div class="summary-row"><span>EnvÃ­o</span><span>$${DELIVERY_FEE.toFixed(2)}</span></div><div class="summary-total"><span>Total a Pagar</span><span>$${total.toFixed(2)}</span></div></div>`;
      
      cartContent.innerHTML = `
        <div id="cartView">
          ${itemsHtml}
          <!-- BOTÃ“N ACTUALIZADO Y BOTÃ“N SEGUIR COMPRANDO -->
          <button class="btn-realizar-pedido" onclick="showCheckoutForm()">REALIZAR PEDIDO</button>
          <button class="btn-seguir-comprando" onclick="closeCart()">Agregar mÃ¡s productos</button>
        </div>
        <div id="checkoutView" style="display:none;"><div class="checkout-form"><h3 style="color:var(--text-dark); margin-bottom:20px; font-size:1.3rem; font-weight:900;">Detalles de Entrega</h3><input type="text" id="bot_field" style="display:none" tabindex="-1"><input type="text" id="cName" placeholder="Nombre completo"><input type="email" id="cEmail" placeholder="Correo electrÃ³nico"><input type="tel" id="cPhone" placeholder="TelÃ©fono"><textarea id="cAddress" placeholder="DirecciÃ³n completa" rows="3"></textarea><button class="checkout-btn" onclick="processCheckout()">CONFIRMAR PEDIDO</button><button class="btn-volver-carrito" onclick="hideCheckoutForm()">Volver al resumen</button></div></div>`;
    }

    function showCheckoutForm() { document.getElementById('cartView').style.display = 'none'; document.getElementById('checkoutView').style.display = 'block'; }
    function hideCheckoutForm() { document.getElementById('checkoutView').style.display = 'none'; document.getElementById('cartView').style.display = 'block'; }
    function removeFromCart(index) { cart.splice(index, 1); updateCartCount(); renderCart(); }

    function processCheckout() {
      if (document.getElementById('bot_field') && document.getElementById('bot_field').value !== "") return; 
      const name = document.getElementById('cName').value.trim(); const email = document.getElementById('cEmail').value.trim();
      const phone = document.getElementById('cPhone').value.trim(); const address = document.getElementById('cAddress').value.trim();
      
      if (!name || !email || !phone || !address) { showNotification('Completa todos tus datos de envÃ­o', 'error'); return; }
      
      const btn = document.querySelector('.checkout-btn');
      btn.disabled = true; btn.textContent = 'Procesando...';

      const orderData = { customerName: name, customerEmail: email, customerPhone: phone, customerAddress: address, items: cart };

      fetch(GAS_BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(orderData)
      })
      .then(response => response.json())
      .then(res => {
        if (res.success) {
          cart = []; updateCartCount(); closeCart(); document.getElementById('successModal').style.display = 'flex';
        } else { showNotification('Error: ' + res.message, 'error'); btn.disabled = false; btn.textContent = 'CONFIRMAR PEDIDO'; }
      })
      .catch(error => {
        console.log("PeticiÃ³n completada", error);
        cart = []; updateCartCount(); closeCart(); document.getElementById('successModal').style.display = 'flex';
      });
    }
    
    function closeSuccessModal() { document.getElementById('successModal').style.display = 'none'; }
    function showNotification(msg, type = 'success') {
      const el = document.getElementById('notification'); el.textContent = msg; el.className = type === 'error' ? 'notification error' : 'notification';
      el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 4000);
    }
  </script>
</body>
</html>
