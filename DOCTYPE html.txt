<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0A313E">
  <title>Mr.Packaging - Tienda</title>
  <style>
    /* --- ESTILOS ARQUITECTURA FLEXBOX (SOLUCIÓN DEFINITIVA AL CONGELAMIENTO) --- */
    :root {
      --primary-color: #0A313E;
      --secondary-color: #1a4d5e;
      --accent-color: #e53935; 
      --buy-color: #FF9900; 
      --success-color: #2e7d32;
      --light-bg: #f5f5f5;
      --white: #ffffff;
      --text-dark: #222222;
      --shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* 1. BLOQUEO TOTAL DEL BODY: El navegador ya no intentará redimensionar la pantalla */
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--text-dark);
      font-size: 18px; 
      width: 100%;
      height: 100%;
      overflow: hidden; /* Prohibe el scroll nativo problemático del iframe */
    }

    /* 2. CONTENEDOR PRINCIPAL FLEXIBLE */
    .app-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    /* 3. ENCABEZADO ESTÁTICO (Sin position: fixed) */
    .top-nav-container {
      flex-shrink: 0; /* Evita que el encabezado cambie de tamaño */
      background: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
    }

    header {
      color: var(--white); padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo { font-size: 1.6rem; font-weight: 900; letter-spacing: 1px; }
    
    .top-cart-container {
      background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 25px;
      display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s;
    }
    .top-cart-container:active { background: rgba(255,255,255,0.3); }
    .top-cart-icon { font-size: 1.5rem; line-height: 1;}
    .top-cart-text { font-weight: bold; font-size: 1.1rem; color: white;}
    .top-cart-badge {
      background: var(--buy-color); color: #000; border-radius: 50%; 
      width: 28px; height: 28px; font-size: 1.1rem; font-weight: 900; 
      display: flex; justify-content: center; align-items: center; 
    }

    .filter-container {
      display: flex; overflow-x: auto; gap: 12px; padding: 15px; scrollbar-width: none; background: var(--primary-color); border-top: 1px solid rgba(255,255,255,0.1);
    }
    .filter-container::-webkit-scrollbar { display: none; }
    .filter-btn {
      flex: 0 0 auto; padding: 12px 24px; border: none; background-color: rgba(255,255,255,0.15); color: var(--white); border-radius: 30px; font-weight: 800; font-size: 1.1rem; cursor: pointer;
    }
    .filter-btn.active { background-color: var(--buy-color); color: #000; }

    /* 4. ÁREA DE SCROLL INDEPENDIENTE: Suave y libre de bugs */
    .main-content {
      flex-grow: 1; /* Toma todo el espacio restante debajo del header */
      overflow-y: auto; /* Solo esta parte hace scroll */
      -webkit-overflow-scrolling: touch; /* Scroll suave para iPhone */
      padding-bottom: 90px; /* Espacio para que el último producto se vea bien */
    }

    .container { padding: 20px 15px; max-width: 800px; margin: 0 auto; }

    /* --- TARJETAS DE PRODUCTO --- */
    .products-grid { 
      display: flex; flex-direction: column; gap: 40px; 
    }
    
    .product-card {
      background-color: var(--white); border-radius: 20px; box-shadow: var(--shadow); 
      display: flex; flex-direction: column; overflow: hidden; border: 1px solid #eaeaea;
    }

    .product-image-container { 
      position: relative; width: 100%; height: 380px; 
      background: #fff; border-bottom: 1px solid #f0f0f0; padding: 15px; 
    }
    .product-slide { width: 100%; height: 100%; object-fit: contain; display: none; } 
    .product-slide.active { display: block; }
    
    .card-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; z-index: 5; cursor: pointer;}
    .card-nav.prev { left: 10px; }
    .card-nav.next { right: 10px; }
    .photo-badge { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 8px 18px; border-radius: 20px; font-size: 1.1rem; font-weight: bold; }

    .product-info { padding: 25px 20px; display: flex; flex-direction: column; }
    
    .product-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .product-titles { flex: 1; padding-right: 15px; }
    .product-name { font-size: 1.8rem; font-weight: 900; color: var(--primary-color); line-height: 1.2; margin-bottom: 8px; }
    .product-description { font-size: 1.2rem; color: #666; line-height: 1.4; }
    
    .color-select { width: 140px; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 1.2rem; background-color: var(--light-bg); font-weight: 800; color: var(--primary-color); outline: none; cursor: pointer; }

    .purchase-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; background: #fafafa; padding: 15px; border-radius: 16px; border: 1px solid #eee;}
    
    .stepper-container { display: flex; align-items: center; background: var(--white); border-radius: 40px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd;}
    .stepper-btn { background: var(--white); border: none; width: 55px; height: 55px; border-radius: 50%; font-size: 2.5rem; color: var(--primary-color); cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 6px; transition: background 0.2s; }
    .stepper-btn:active { background: #e0e0e0; }
    .stepper-val { width: 75px; text-align: center; font-weight: 900; font-size: 1.6rem; color: var(--text-dark); }
    
    .total-preview-container { text-align: right; }
    .total-label { font-size: 0.9rem; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 3px;}
    .total-preview { font-weight: 900; font-size: 2rem; color: var(--success-color); line-height: 1;}

    .add-to-cart-btn { background-color: var(--primary-color); color: var(--white); border: none; padding: 22px; border-radius: 16px; font-weight: 900; font-size: 1.5rem; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; cursor: pointer; transition: transform 0.2s;}
    .add-to-cart-btn:active { transform: scale(0.98); }
    
    .view-prices-btn { background: transparent; border: none; color: #1565C0; font-weight: 800; font-size: 1.3rem; width: 100%; padding: 20px 0 0 0; text-align: center; text-decoration: underline; cursor: pointer;}

    /* MODALES WEB ESTÁNDAR */
    .modal { 
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: flex-end;
      padding: 10px;
    }
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--light-bg); width: 100%; max-width: 800px; max-height: 90vh; 
      border-radius: 24px 24px 0 0; display: flex; flex-direction: column; overflow: hidden;
      animation: slideUpWeb 0.3s ease-out;
    }
    @keyframes slideUpWeb { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px; background-color: var(--white); color: var(--text-dark); border-bottom: 1px solid #eee; z-index: 2001; }
    .modal-header h2 { font-size: 1.8rem; margin: 0; font-weight: 900; }
    .modal-close { background: #f5f5f5; color: var(--text-dark); border: none; font-size: 2rem; font-weight: bold; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer;}
    .modal-body { flex: 1; overflow-y: auto; padding: 20px; background: var(--light-bg); -webkit-overflow-scrolling: touch; }

    /* MODALES CENTRADOS PROFESIONALES */
    .modal-centered {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 5000;
      justify-content: center; align-items: center; padding: 20px;
    }
    .modal-centered-content {
      background: white; border-radius: 24px; padding: 30px; width: 100%; max-width: 450px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center;
      animation: scaleUp 0.3s ease-out;
    }
    @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    #priceModalProductName { font-weight: 900; font-size: 1.6rem; color: var(--primary-color); margin-bottom: 20px; line-height: 1.3;}
    .price-table { width: 100%; border-collapse: collapse; font-size: 1.4rem; margin-bottom: 25px;}
    .price-table td { padding: 18px 10px; border-bottom: 1px solid #eee; text-align: left; }
    .price-qty-col { color: #555; font-weight: 700; }
    .price-val-col { text-align: right !important; font-weight: 900; color: var(--primary-color); font-size: 1.5rem; }

    /* CARRITO DE COMPRAS */
    .cart-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 15px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .cart-item img { width: 100px; height: 100px; object-fit: contain; border-radius: 12px; background: #f9f9f9; border: 1px solid #eee;}
    .cart-item-name { font-size: 1.3rem; font-weight: 900; margin-bottom: 5px; color: var(--primary-color); line-height: 1.2;}
    .cart-item-details { font-size: 1.1rem; color: #666; font-weight: 600;}
    .cart-remove-btn { background: #ffebee; color: var(--accent-color); border: none; padding: 10px 15px; border-radius: 10px; font-weight: 900; font-size: 1.1rem; margin-top: 8px; cursor: pointer;}
    
    .cart-summary { background: white; padding: 25px 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; margin-bottom: 20px; }
    .summary-row { display: flex; justify-content: space-between; font-size: 1.3rem; margin-bottom: 15px; color: #555; font-weight: 700; }
    .summary-total { display: flex; justify-content: space-between; font-size: 2rem; font-weight: 900; color: var(--success-color); border-top: 2px solid #eee; padding-top: 20px; margin-top: 10px; }

    .btn-realizar-pedido { width: 100%; background: var(--buy-color); color: #000; padding: 24px; border: none; border-radius: 16px; font-weight: 900; font-size: 1.6rem; margin-bottom: 30px; cursor: pointer;}
    
    .checkout-form { background:white; padding:25px 20px; border-radius:16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 30px;}
    .checkout-form input, .checkout-form textarea { width: 100%; padding: 18px; border: 2px solid #ddd; border-radius: 12px; font-size: 1.3rem; margin-bottom: 15px; background-color: var(--white); font-weight: 600; outline: none; }
    .checkout-form input:focus, .checkout-form textarea:focus { border-color: var(--primary-color); }
    .checkout-btn { width: 100%; background: var(--buy-color); color: #000; padding: 24px; border: none; border-radius: 16px; font-weight: 900; font-size: 1.6rem; margin-top: 10px; cursor: pointer;}
    
    .btn-volver-carrito { width: 100%; background: transparent; color: #666; padding: 15px; border: none; font-weight: 800; font-size: 1.3rem; margin-top: 15px; text-decoration: underline; cursor: pointer;}

    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 18px 35px; border-radius: 40px; z-index: 6000; display: none; font-size: 1.2rem; font-weight: 900; white-space: nowrap; box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .notification.error { background-color: var(--accent-color); }

    .loading { text-align: center; padding: 5rem 0; }
    .spinner { border: 6px solid #ddd; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 70px; height: 70px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .modal-image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; }
    .modal-image-content { max-width: 100%; max-height: 100%; object-fit: contain; }
    .close-zoom-fixed { position: absolute; top: 20px; right: 20px; color: white; background: rgba(255,255,255,0.2); border: 2px solid white; width: 60px; height: 60px; border-radius: 50%; font-size: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* FAB WhatsApp */
    .whatsapp-fab {
      position: fixed; bottom: 30px; right: 25px;
      background-color: #25D366; color: white; width: 70px; height: 70px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 2.5rem; box-shadow: 0 4px 15px rgba(37,211,102,0.4); text-decoration: none; z-index: 900;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="app-wrapper">

  <!-- BLOQUE SUPERIOR ESTÁTICO (Nunca usa position: fixed) -->
  <div class="top-nav-container">
    <header>
      <div class="logo">MR.PACKAGING</div>
      <div class="top-cart-container" onclick="openCart()">
        <span class="top-cart-icon">??</span>
        <span class="top-cart-text">Pedido</span>
        <span class="top-cart-badge" id="topCartCount">0</span>
      </div>
    </header>
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
      <button class="filter-btn" onclick="filterProducts('Cajas', this)">Cajas</button>
      <button class="filter-btn" onclick="filterProducts('Bolsas', this)">Bolsas</button>
      <button class="filter-btn" onclick="filterProducts('Tag', this)">Tag</button>
      <button class="filter-btn" onclick="filterProducts('Papel Seda', this)">Papel Seda</button>
      <button class="filter-btn" onclick="filterProducts('Sticker', this)">Sticker</button>
    </div>
  </div>

  <!-- BLOQUE INFERIOR DE SCROLL (Aquí es donde ocurre la magia sin congelarse) -->
  <div class="main-content" id="scrollContainer">
    <div class="container">
      <div class="products-grid" id="productsGrid">
        <div class="loading">
          <div class="spinner"></div>
          <p style="font-size:1.4rem; color:#666; font-weight:900;">Cargando inventario...</p>
        </div>
      </div>
    </div>
  </div>

</div> <!-- Fin app-wrapper -->

  <a href="https://wa.me/50372635125?text=Hola!%20Tengo%20una%20consulta%20sobre%20empaques" target="_blank" class="whatsapp-fab">??</a>

  <!-- MODAL CARRITO -->
  <div class="modal" id="cartModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>?? Tu Pedido</h2>
        <button class="modal-close" onclick="closeCart()">×</button>
      </div>
      <div class="modal-body" id="cartContent"></div>
    </div>
  </div>

  <!-- MODAL DE PRECIOS CENTRADO -->
  <div class="modal-centered" id="priceModal">
    <div class="modal-centered-content">
      <h2 id="priceModalProductName"></h2>
      <table class="price-table">
        <tbody id="priceTableBody"></tbody>
      </table>
      <button style="width:100%; padding:18px; background:var(--primary-color); color:white; border-radius:14px; font-size:1.4rem; font-weight:bold; border:none; cursor:pointer;" onclick="closePriceModal()">Entendido</button>
    </div>
  </div>

  <!-- MODAL DE SALIDA (Para el botón atrás) -->
  <div class="modal-centered" id="exitModal">
    <div class="modal-centered-content">
      <h2 style="color:var(--primary-color); margin-bottom:15px; font-size:1.8rem; font-weight:900;">¿Ya te vas?</h2>
      <p id="exitModalText" style="color:#666; margin-bottom:25px; font-size:1.3rem; line-height:1.4;"></p>
      
      <button style="width:100%; padding:18px; background:var(--primary-color); color:white; border-radius:14px; font-size:1.4rem; font-weight:bold; border:none; margin-bottom:15px; cursor:pointer;" onclick="cancelExit()">Seguir comprando</button>
      <button style="width:100%; padding:18px; background:transparent; color:var(--accent-color); border-radius:14px; font-size:1.4rem; font-weight:bold; border:2px solid var(--accent-color); cursor:pointer;" onclick="confirmExit()">Salir de la tienda</button>
    </div>
  </div>

  <!-- MODAL ÉXITO -->
  <div class="modal-centered" id="successModal">
    <div class="modal-centered-content">
      <div style="font-size: 80px; color: #4CAF50; margin: 0 auto 20px auto; background: #e8f5e9; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">?</div>
      <h2 style="color:var(--primary-color); font-size:2.2rem; margin-bottom:15px; font-weight:900;">¡Orden Recibida!</h2>
      <p style="color: #666; margin-bottom: 30px; font-size: 1.3rem; line-height: 1.4;">Hemos enviado los detalles a tu correo electrónico.</p>
      <button style="width:100%; padding:18px; background:var(--primary-color); color:white; border-radius:14px; font-size:1.4rem; font-weight:bold; border:none; cursor:pointer;" onclick="closeSuccessModal()">Volver a la Tienda</button>
    </div>
  </div>

  <!-- MODAL ZOOM -->
  <div class="modal-image-overlay" id="imageZoomModal">
    <button class="close-zoom-fixed" onclick="closeImageModal()">×</button>
    <img src="" class="modal-image-content" id="imgZoomContent">
  </div>

  <div class="notification" id="notification"></div>

  <script>
    const firebaseConfig = { databaseURL: "https://mrpackaging-app-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [];
    let cart = [];
    let currentCategory = 'all'; 
    const DELIVERY_FEE = 3.50;
    let productSlideIndices = {}; 

    // --- TRAMPA DEL BOTÓN ATRÁS SE MANTIENE POR SEGURIDAD ---
    window.onload = function() { 
      history.pushState({page: 'trampa_salida'}, '', '#app');
      history.pushState({page: 'tienda_principal'}, '', '#tienda');
      loadProducts(); 
    };

    window.addEventListener('popstate', function(event) {
      const isCartOpen = document.getElementById('cartModal').classList.contains('active');
      const isPriceOpen = document.getElementById('priceModal').style.display === 'flex';
      const isZoomOpen = document.getElementById('imageZoomModal').style.display === 'flex';
      
      if (isCartOpen || isPriceOpen || isZoomOpen) {
        closeCart();
        closePriceModal();
        closeImageModal();
        history.pushState({page: 'tienda_principal'}, '', '#tienda'); 
        return;
      }

      if (event.state && event.state.page === 'trampa_salida') {
        const exitText = cart.length > 0 
          ? "Tienes empaques en tu pedido. Si sales ahora, se perderá tu carrito." 
          : "Esperamos verte de nuevo pronto.";
        
        document.getElementById('exitModalText').innerText = exitText;
        document.getElementById('exitModal').style.display = 'flex';
      }
    });

    function cancelExit() {
      document.getElementById('exitModal').style.display = 'none';
      history.pushState({page: 'tienda_principal'}, '', '#tienda'); 
    }
    function confirmExit() { history.go(-2); }

    // --- CARGA DE PRODUCTOS ---
    async function loadProducts() {
      try {
        const snapshot = await db.ref('productos').once('value');
        const data = snapshot.val();

        if (data) {
          products = Object.values(data).filter(p => p !== null).map(p => {
            let imgArray = p.image ? p.image.toString().split(',').map(url => url.trim()).filter(url => url !== "") : [];
            if (imgArray.length === 0) imgArray = ['https://via.placeholder.com/300?text=No+Image'];
            return {
              id: p.id, name: p.name, category: p.category, description: p.description,
              images: imgArray, colors: Array.isArray(p.colors) ? p.colors : [p.colors], 
              priceTiers: p.priceTiers, stock: p.stock
            };
          });
        }
        renderProducts();
        const loader = document.querySelector('.loading');
        if (loader) loader.style.display = 'none';
      } catch (error) { showNotification('Error cargando el catálogo', 'error'); }
    }

    function filterProducts(category, btn) {
      currentCategory = category;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      renderProducts();
      
      // NUEVO MANDO DE SCROLL: Se aplica al contenedor interno
      const scrollCont = document.getElementById('scrollContainer');
      if (scrollCont) { scrollCont.scrollTo({ top: 0, behavior: 'smooth' }); }
    }

    function calculatePrice(quantity, priceTiers) {
      if (quantity >= 1 && quantity <= 25) return priceTiers.tier1;
      if (quantity >= 26 && quantity <= 50) return priceTiers.tier2;
      if (quantity >= 51 && quantity <= 100) return priceTiers.tier3;
      if (quantity >= 101 && quantity <= 500) return priceTiers.tier4;
      return priceTiers.tier5;
    }

    // --- LÓGICA DE 25 EN 25 ESTRICTA ---
    function updateQty(productId, isPlus) {
      const display = document.getElementById(`qty-display-${productId}`);
      let current = parseInt(display.innerText) || 25; 
      
      let next = isPlus ? current + 25 : current - 25;

      if (next < 25) { 
        showNotification('El mínimo es 25 unidades', 'error'); 
        next = 25; 
      }
      if (next > 1000) { 
        showNotification('Máximo 1000 unidades', 'error'); 
        next = 1000; 
      }
      
      display.innerText = next;
      updatePricePreview(productId);
    }

    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      const filtered = currentCategory === 'all' ? products : products.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());

      if (filtered.length === 0) { grid.innerHTML = '<p style="text-align:center; padding:50px; color:#666; font-size:1.5rem; font-weight:900;">No hay productos.</p>'; return; }

      filtered.forEach(product => {
        productSlideIndices[product.id] = 0;
        const card = document.createElement('div');
        card.className = 'product-card';
        
        let imagesHtml = '';
        product.images.forEach((img, index) => {
          const activeClass = index === 0 ? 'active' : '';
          imagesHtml += `<img src="${img}" loading="lazy" class="product-slide ${activeClass}" id="slide-${product.id}-${index}" onclick="openImageZoom('${product.id}', ${index})">`;
        });

        let navHtml = '';
        if (product.images.length > 1) {
          navHtml = `<button class="card-nav prev" onclick="changeCardSlide('${product.id}', -1)">&#10094;</button>
                     <button class="card-nav next" onclick="changeCardSlide('${product.id}', 1)">&#10095;</button>
                     <div class="photo-badge" id="badge-${product.id}">1/${product.images.length}</div>`;
        }

        let colorOptionsHtml = '';
        if (product.colors && product.colors.length > 0 && product.colors[0] !== "") {
            colorOptionsHtml = `<select class="color-select" id="color-${product.id}">
                                  ${product.colors.map(c => `<option value="${c.trim()}">${c.trim()}</option>`).join('')}
                                </select>`;
        } else { colorOptionsHtml = `<input type="hidden" id="color-${product.id}" value="Estándar">`; }

        const initialTotal = calculatePrice(25, product.priceTiers) * 25;

        card.innerHTML = `
          <div class="product-image-container">${imagesHtml}${navHtml}</div>
          
          <div class="product-info">
            <div class="product-header-row">
               <div class="product-titles">
                 <h3 class="product-name">${product.name}</h3>
                 <div class="product-description">${product.description}</div>
               </div>
               ${colorOptionsHtml}
            </div>
            
            <div class="purchase-controls">
              <div class="stepper-container">
                <button type="button" class="stepper-btn" onclick="updateQty('${product.id}', false)">-</button>
                <div class="stepper-val" id="qty-display-${product.id}">25</div>
                <button type="button" class="stepper-btn" onclick="updateQty('${product.id}', true)">+</button>
              </div>
              <div class="total-preview-container">
                <div class="total-label">Subtotal</div>
                <div class="total-preview" id="preview-${product.id}">$${initialTotal.toFixed(2)}</div>
              </div>
            </div>
            
            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')">?? Agregar al Pedido</button>
            <button class="view-prices-btn" onclick="openPriceModal('${product.id}')">Ver tabla de precios por volumen</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function changeCardSlide(productId, direction) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      let currentIndex = productSlideIndices[productId];
      document.getElementById(`slide-${productId}-${currentIndex}`).classList.remove('active');
      currentIndex += direction;
      if (currentIndex >= product.images.length) currentIndex = 0;
      if (currentIndex < 0) currentIndex = product.images.length - 1;
      productSlideIndices[productId] = currentIndex;
      document.getElementById(`slide-${productId}-${currentIndex}`).classList.add('active');
      const badge = document.getElementById(`badge-${productId}`);
      if(badge) badge.textContent = `${currentIndex + 1}/${product.images.length}`;
    }

    function openImageZoom(productId, index) {
      const product = products.find(p => p.id === productId);
      document.getElementById('imgZoomContent').src = product.images[index];
      document.getElementById('imageZoomModal').style.display = 'flex';
      history.pushState({ modal: 'zoom' }, '', '#zoom');
    }
    function closeImageModal() { document.getElementById('imageZoomModal').style.display = 'none'; }

    function openPriceModal(productId) {
      const product = products.find(p => p.id === productId);
      document.getElementById('priceModalProductName').textContent = product.name;
      document.getElementById('priceTableBody').innerHTML = `
        <tr><td class="price-qty-col">1 - 25 u.</td><td class="price-val-col">$${product.priceTiers.tier1.toFixed(2)}</td></tr>
        <tr><td class="price-qty-col">26 - 50 u.</td><td class="price-val-col">$${product.priceTiers.tier2.toFixed(2)}</td></tr>
        <tr><td class="price-qty-col">51 - 100 u.</td><td class="price-val-col">$${product.priceTiers.tier3.toFixed(2)}</td></tr>
        <tr><td class="price-qty-col">101 - 500 u.</td><td class="price-val-col">$${product.priceTiers.tier4.toFixed(2)}</td></tr>
        <tr><td class="price-qty-col" style="border:none;">501+ u.</td><td class="price-val-col" style="border:none;">$${product.priceTiers.tier5.toFixed(2)}</td></tr>
      `;
      document.getElementById('priceModal').style.display = 'flex';
      history.pushState({ modal: 'precios' }, '', '#precios');
    }
    function closePriceModal() { document.getElementById('priceModal').style.display = 'none'; }

    function updatePricePreview(productId) {
      const product = products.find(p => p.id === productId);
      const quantity = parseInt(document.getElementById(`qty-display-${productId}`).innerText) || 25;
      const price = calculatePrice(quantity, product.priceTiers);
      document.getElementById(`preview-${productId}`).textContent = `$${(price * quantity).toFixed(2)}`;
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      const colorInput = document.getElementById(`color-${productId}`);
      const quantity = parseInt(document.getElementById(`qty-display-${productId}`).innerText) || 25;

      const unitPrice = calculatePrice(quantity, product.priceTiers);
      cart.push({ id: product.id, name: product.name, image: product.images[0], color: colorInput ? colorInput.value : "Estándar", quantity: quantity, unitPrice: unitPrice, total: unitPrice * quantity });
      
      updateCartCount();
      showNotification('¡Agregado a tu pedido!');
      
      document.getElementById(`qty-display-${productId}`).innerText = "25";
      updatePricePreview(productId);
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('topCartCount').textContent = count;
    }

    function openCart() {
      renderCart();
      document.getElementById('cartModal').classList.add('active');
      history.pushState({ modal: 'carrito' }, '', '#carrito');
    }
    function closeCart() { document.getElementById('cartModal').classList.remove('active'); }

    function renderCart() {
      const cartContent = document.getElementById('cartContent');
      if (cart.length === 0) {
        cartContent.innerHTML = '<div style="text-align:center; padding-top:80px;"><div style="font-size:6rem; opacity:0.2; margin-bottom:20px;">??</div><h3 style="color:#444; font-size:1.8rem;">Tu pedido está vacío</h3><p style="color:#888; margin-top:10px; font-size:1.3rem;">¡Agrega empaques para continuar!</p></div>';
        return;
      }
      const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
      const total = subtotal + DELIVERY_FEE;
      
      let itemsHtml = `<div>`;
      cart.forEach((item, index) => {
        itemsHtml += `
          <div class="cart-item">
            <img src="${item.image}">
            <div style="flex:1;">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-details">${item.color} | Cantidad: ${item.quantity}</div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <div style="font-weight:900; font-size:1.4rem; color:var(--text-dark);">$${item.total.toFixed(2)}</div>
                <button class="cart-remove-btn" onclick="removeFromCart(${index})">Quitar</button>
              </div>
            </div>
          </div>`;
      });
      itemsHtml += `</div>
        <div class="cart-summary">
          <div class="summary-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
          <div class="summary-row"><span>Costo de Envío</span><span>$${DELIVERY_FEE.toFixed(2)}</span></div>
          <div class="summary-total"><span>Total a Pagar</span><span>$${total.toFixed(2)}</span></div>
        </div>`;

      cartContent.innerHTML = `
        <div id="cartView">
          ${itemsHtml}
          <button class="btn-realizar-pedido" onclick="showCheckoutForm()">PROCEDER AL PAGO</button>
        </div>
        <div id="checkoutView" style="display:none;">
          <div class="checkout-form">
            <h3 style="color:var(--text-dark); margin-bottom:25px; font-size:1.5rem; font-weight:900;">Detalles de Entrega</h3>
            <input type="text" id="bot_field" style="display:none" tabindex="-1">
            <input type="text" id="cName" placeholder="Nombre completo">
            <input type="email" id="cEmail" placeholder="Correo electrónico">
            <input type="tel" id="cPhone" placeholder="Teléfono (Ej: 7777-7777)">
            <textarea id="cAddress" placeholder="Dirección completa exacta" rows="3"></textarea>
            <button class="checkout-btn" onclick="processCheckout()">CONFIRMAR PEDIDO</button>
            <button class="btn-volver-carrito" onclick="hideCheckoutForm()">Volver al resumen del carrito</button>
          </div>
        </div>
      `;
    }

    function showCheckoutForm() { document.getElementById('cartView').style.display = 'none'; document.getElementById('checkoutView').style.display = 'block'; }
    function hideCheckoutForm() { document.getElementById('checkoutView').style.display = 'none'; document.getElementById('cartView').style.display = 'block'; }
    function removeFromCart(index) { cart.splice(index, 1); updateCartCount(); renderCart(); }

    function processCheckout() {
      if (document.getElementById('bot_field') && document.getElementById('bot_field').value !== "") return; 

      const name = document.getElementById('cName').value.trim();
      const email = document.getElementById('cEmail').value.trim();
      const phone = document.getElementById('cPhone').value.trim();
      const address = document.getElementById('cAddress').value.trim();

      if (!name || !email || !phone || !address) { showNotification('Completa todos tus datos de envío', 'error'); return; }
      
      const btn = document.querySelector('.checkout-btn');
      btn.disabled = true; btn.textContent = 'Procesando...';

      google.script.run
        .withSuccessHandler(function(res) {
          if (res.success) {
            cart = []; updateCartCount(); closeCart();
            document.getElementById('successModal').style.display = 'flex';
          } else { alert('Error: ' + res.message); btn.disabled = false; btn.textContent = 'CONFIRMAR PEDIDO'; }
        })
        .processOrder({ customerName: name, customerEmail: email, customerPhone: phone, customerAddress: address, items: cart });
    }
    
    function closeSuccessModal() { document.getElementById('successModal').style.display = 'none'; }
    function showNotification(msg, type = 'success') {
      const el = document.getElementById('notification');
      el.textContent = msg;
      el.className = type === 'error' ? 'notification error' : 'notification';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }
  </script>
</body>
</html>

